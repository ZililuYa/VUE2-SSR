<template>
  <div class="">
    <div class="featurebar">
      <ul class="ul">
        <li>
          <span class="badge">{{data.id}}</span>
          <b>{{data.name}}</b>
        </li>
      </ul>
    </div>
    <div class="main">
      <div class="row-table">
        <div class="col-main">
          <fieldset class="fieldset">
            <legend>任务描述</legend>
            <div class="content" v-html="data.content"></div>
          </fieldset>
          <fieldset class="fieldset">
            <legend>历史记录</legend>
            <logData :data=" data.logList"></logData>
          </fieldset>
          <div class="text-center tool-a">
            <a href="javascript:;" @click="taskAssignShow=true"><i class="fa fa-hand-o-right"></i> 指派</a>
            <a href="javascript:;" @click="taskActionShow=true"><i class="fa fa-play"></i> 开始</a>
            <a href="javascript:;"><i class="fa fa-clock-o"></i> 工时</a>
            <a href="javascript:;" @click="taskFinishShow=true"><i class="fa fa-check-circle"></i> 完成</a>
            <a href="javascript:;" @click="close"><i class="fa fa-close"></i> 关闭</a>
            <router-link :to="'/project/taskEdit/'+$route.params.id"><i class="fa fa-edit"></i> 编辑</router-link>
            <router-link :to="'/project/task/' + data.projectId"><i class="fa fa-reply"></i> 返回</router-link>
          </div>
        </div>
        <div class="col-side">
          <fieldset class="fieldset">
            <legend>基本信息</legend>
            <div class="content">
              <table class="table-content">
                <tbody>
                <tr>
                  <th>所属项目</th>
                  <td>{{data.projectName}}</td>
                </tr>
                <tr>
                  <th>任务名称</th>
                  <td>{{data.name}}</td>
                </tr>
                <tr>
                  <th>指派给</th>
                  <td>{{data.assignedName}}</td>
                </tr>
                <tr>
                  <th>任务类型</th>
                  <td>{{data.type}}</td>
                </tr>
                <tr>
                  <th>任务状态</th>
                  <td>{{data.status}}</td>
                </tr>
                <tr>
                  <th>优先级</th>
                  <td>{{data.priorityId}}</td>
                </tr>
                <tr>
                  <th>抄送给</th>
                  <td></td>
                </tr>
                </tbody>
              </table>
            </div>
          </fieldset>

          <fieldset class="fieldset">
            <legend>工时信息</legend>
            <div class="content">
              <table class="table-content">
                <tbody>
                <tr>
                  <th>预计开始</th>
                  <td></td>
                </tr>
                <tr>
                  <th>实际开始</th>
                  <td></td>
                </tr>
                <tr>
                  <th>截止日期</th>
                  <td></td>
                </tr>
                <tr>
                  <th>最初预计</th>
                  <td></td>
                </tr>
                <tr>
                  <th>总消耗</th>
                  <td></td>
                </tr>
                <tr>
                  <th>预计剩余</th>
                  <td></td>
                </tr>
                </tbody>
              </table>
            </div>
          </fieldset>
          <fieldset class="fieldset">
            <legend>任务的一生</legend>
            <div class="content">
              <table class="table-content">
                <tbody>
                <tr>
                  <th>由谁创建</th>
                </tr>
                <tr>
                  <th>由谁完成</th>
                </tr>
                <tr>
                  <th>由谁取消</th>
                </tr>
                <tr>
                  <th>由谁关闭</th>
                </tr>
                <tr>
                  <th>关闭原因</th>
                </tr>
                <tr>
                  <th>最后编辑</th>
                </tr>
                </tbody>
              </table>
            </div>
          </fieldset>
        </div>
      </div>
    </div>

    <taskAssign v-model="taskAssignShow" :typeList="typeList" :data="data" @success="refresh"></taskAssign>
    <taskFinish v-model="taskFinishShow" :typeList="typeList" :data="data" @success="refresh"></taskFinish>
    <taskAction v-model="taskActionShow" :data="data" @success="refresh"></taskAction>

  </div>
</template>

<script>
  import { mapGetters } from 'vuex'
  import logData from '../../../components/history/logs.vue'
  import taskAssign from './taskAssign.vue'
  import taskAction from './taskAction.vue'
  import taskFinish from './taskFinish.vue'
  import api from 'src/api'

  export default {
    components: {logData, taskAssign, taskAction, taskFinish},
    data () {
      return {
        taskAssignShow: false,
        taskFinishShow: false,
        taskActionShow: false
      }
    },
    computed: {
      ...mapGetters({
        data: 'projectTaskDetail',
        typeList: 'projectTaskTypeList'
      })
    },
    methods: {
      close () {
        this.$confirm({
          title: '系统提示',
          content: '确定删除吗？'
        })
          .then(() => {
            api.post('/v1/task/update', {id: this.data.id, delStatus: 2}).then((response) => {
              this.$notify(response.message)
              this.$router.push('/project/task/' + this.data.projectId)
            })
          })
          .catch(() => {
          })
      },
      refresh () {
        window.history.go(0)
      }
    },
    mounted () {
    },
    asyncData ({store, route}) {
      let arr = route.params.id.split('-')
      return Promise.all([store.dispatch('isProjectTaskDetails', arr[1]), store.dispatch('isProjectTaskType', {id: arr[0]})])
    }
  }
</script>

