<template>
  <div id="topbar" class="topbar">
    <div id="topnav" class="topnav pull-right">
      <dropdown tag="div" class="tags">
        <a class="dropdown-toggle" role="button">{{users.name}}<span class="caret"></span></a>
        <template slot="dropdown">
          <li><a role="button" @click="$router.push('/organization/company')">个人档案</a></li>
          <li><a role="button" @click="opens = true">修改密码</a></li>
        </template>
      </dropdown>
      <a class="tags" href="javascript:void(0);" @click="signOut">退出</a>
    </div>
    <h5 class="companyname">{{company.name}}</h5>
    <modal v-model="opens" :footer="false">
      <span slot="title">修改密码</span>
      <formData class="form-horizontal send-form" ref="editPasswordForm">
        <div class="form-group">
          <label for="name" class="col-sm-3 control-label"> 用户</label>
          <div class="col-sm-8">
            <input type="text" class="form-control" :value="users.username" disabled>
          </div>
        </div>
        <div class="form-group">
          <label for="name" class="col-sm-3 control-label"> 原密码</label>
          <div class="col-sm-8">
            <input type="password" class="form-control" v-model="ruleForm.oldPass" fn="fn_oldPass" validate="required">
            <span class="falseHints" id="fn_oldPass"></span>
          </div>
        </div>
        <div class="form-group">
          <label for="name" class="col-sm-3 control-label"> 新密码</label>
          <div class="col-sm-8">
            <input type="password" class="form-control" v-model="ruleForm.newPass" fn="fn_newPass" validate="required">
            <span class="falseHints" id="fn_newPass"></span>
          </div>
        </div>
        <div class="form-group">
          <label for="name" class="col-sm-3 control-label"> 请重复密码</label>
          <div class="col-sm-8">
            <input type="password" class="form-control" v-model="ruleForm.newPassOk" fn="fn_newPassOk" validate="required">
            <span class="falseHints" id="fn_newPassOk"></span>
          </div>
        </div>
        <div class="form-group">
          <label for="name" class="col-sm-3 control-label">&nbsp;</label>
          <div class="col-sm-8">
            <btn type="primary" @click="callback">确认</btn>
          </div>
        </div>
      </formData>
    </modal>
  </div>
</template>
<script>
import api from 'src/api'
import cookies from 'js-cookie'
import formData from 'components/form/form.vue'
export default {
  name: 'TopHeader',
  data() {
    return {
      opens: false,
      ruleForm: {
        oldPass: '',
        newPass: '',
        newPassOk: ''
      }
    }
  },
  props: {
    company: {
      type: Object
    },
    users: {
      type: Object
    }
  },
  created() {},
  components: { formData },
  methods: {
    signOut() {
      this.$confirm({
        title: '提示',
        okText: '确定',
        cancelText: '取消',
        content: '确定要退出登录吗？'
      }).then(() => {
        this.doSignout()
      }).catch(() => {})
    },
    doSignout() {
      api.post('/signout').then((response) => {
        if (response.code === 200) {
          cookies.remove('select_user')
          this.$router.replace({ path: '/user/login' })
        } else {
          this.$notify({
            type: 'danger',
            content: response.message
          })
        }
      }).catch((error) => {
        console.log(error)
      })
    },
    callback(item) {
      const data = this.ruleForm
      let formNull = this.$refs.editPasswordForm.validate()
      if (!formNull) return false
      if (data.newPass === data.newPassOk) {
        this.editPassword(data)
      } else {
        this.opens = true
        this.$notify({
          type: 'danger',
          content: '密码不一致'
        })
      }
    },
    editPassword(params) {
      // console.log(this.$refs.editPasswordForm)
      const param = {
        oldPassword: params.oldPass,
        newPassword: params.newPass
      }
      console.log(param)
      api.post('member/resetPassword', param).then((response) => {
        // console.log(response)
        if (response.code === 200) {
          this.opens = false
          this.$notify({
            type: 'success',
            content: '密码修改成功，即将退出登录，请重新登录！'
          })
          setTimeout(() => {
            this.doSignout()
          }, 5000)
        } else {
          this.$notify({
            type: 'danger',
            content: response.message
          })
        }
      }).catch((error) => {
        console.log(error)
      })
    }
  }
}

</script>
<style lang="less">
.topbar {
  h5 {
    color: #fc0;
    font-weight: normal;
    margin: 0;
  }
}

.topnav {
  margin-top: -6px;
  .tags {
    float: left;
    .dropdown-menu {
      min-width: auto;
      padding: 5px 0;
      li a {
        padding: 6px 20px;
        font-size: 12px;
        transition: all .3s;
        &:hover {
          background-color: #1e232f;
          color: #fff
        }
      }
    }
  }
  a {
    display: block;
    padding: 3px 6px;
    position: relative;
    color: #d1e4f2;
    text-decoration: none;
    &:hover {
      background-color: #3b465e;
    }
  }
}

</style>
