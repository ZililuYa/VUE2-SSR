<template>
  <div class="">
    <div class="featurebar">
      <ul class="ul">
        <li>
          <span class="badge">{{data.id}}</span>
          <b>{{data.name}}</b>
        </li>
      </ul>
    </div>
    <div class="main">
      <div class="row-table">
        <div class="col-main">
          <fieldset class="fieldset">
            <legend>任务描述</legend>
            <!--<div class="content" v-html="data.content"></div>-->
            <editor v-model="item.content" class="content"></editor>
          </fieldset>
          <fieldset class="fieldset">
            <legend>历史记录</legend>
            <logData :data=" data.logList"></logData>
          </fieldset>
          <div class="text-center tool-a">
            <btn type="primary" size="sm" @click="submit">保存</btn>
            <btn size="sm" @click="cancel">取消</btn>
          </div>
        </div>
        <div class="col-side">
          <fieldset class="fieldset">
            <legend>基本信息</legend>
            <div class="content">
              <table class="table-content">
                <tbody>
                <tr>
                  <th>所属项目</th>
                  <td>{{data.projectName}}</td>
                </tr>
                <tr>
                  <th>任务名称</th>
                  <td class="input-group-sm">
                    <input v-model="item.name" class="form-control"></input>
                  </td>
                </tr>
                <tr>
                  <th>指派给</th>
                  <td>{{data.assignedName}}</td>
                </tr>
                <tr>
                  <th>任务类型</th>
                  <td>{{data.type}}</td>
                </tr>
                <tr>
                  <th>任务状态</th>
                  <td>{{data.status}}</td>
                </tr>
                <tr>
                  <th>优先级</th>
                  <!--<td>{{data.priorityId}}</td>-->
                  <td class="input-group-sm">
                    <select v-model="item.priorityId" class="form-control">
                      <option v-for="i in [1,2,3,4,5]" :value="i">{{i}}</option>
                    </select>
                  </td>
                </tr>
                <tr>
                  <th>抄送给</th>
                  <td></td>
                </tr>
                </tbody>
              </table>
            </div>
          </fieldset>

          <fieldset class="fieldset">
            <legend>工时信息</legend>
            <div class="content">
              <table class="table-content">
                <tbody>
                <tr>
                  <th>预计开始</th>
                  <td></td>
                </tr>
                <tr>
                  <th>实际开始</th>
                  <td></td>
                </tr>
                <tr>
                  <th>截止日期</th>
                  <td></td>
                </tr>
                <tr>
                  <th>最初预计</th>
                  <td></td>
                </tr>
                <tr>
                  <th>总消耗</th>
                  <td></td>
                </tr>
                <tr>
                  <th>预计剩余</th>
                  <td></td>
                </tr>
                </tbody>
              </table>
            </div>
          </fieldset>
          <fieldset class="fieldset">
            <legend>任务的一生</legend>
            <div class="content">
              <table class="table-content">
                <tbody>
                <tr>
                  <th>由谁创建</th>
                </tr>
                <tr>
                  <th>由谁完成</th>
                </tr>
                <tr>
                  <th>由谁取消</th>
                </tr>
                <tr>
                  <th>由谁关闭</th>
                </tr>
                <tr>
                  <th>关闭原因</th>
                </tr>
                <tr>
                  <th>最后编辑</th>
                </tr>
                </tbody>
              </table>
            </div>
          </fieldset>
        </div>
      </div>
    </div>
  </div>
</template>

<script>
  import { mapGetters } from 'vuex'
  import logData from 'components/history/logs.vue'
  import api from 'src/api'
  import editor from 'components/editor/editor.vue'

  export default {
    components: {logData, editor},
    data () {
      return {
        item: {}
      }
    },
    computed: {
      ...mapGetters({
        data: 'projectTaskDetail',
        typeList: 'projectTaskTypeList'
      })
    },
    methods: {
      submit () {
        delete this.item.logList
        api.post('/task/update', this.item).then((response) => {
          if (response.code === 200) {
//            this.$alert('添加成功, 3秒后跳转到项目列表')
            this.$alert({
              title: '提示',
              okText: '确定',
              content: '修改成功'
            }).then(() => {
              this.cancel()
            })
          } else {
            this.$notify(response.message)
          }
        })
      },
      cancel () {
        this.$router.push('/project/taskDetails/' + this.$route.params.id)
//        window.location.href = '/project/survey/' + this.item.id
      }
    },
    mounted () {
      let item = JSON.stringify(this.data)
      this.item = JSON.parse(item)
    },
    asyncData ({store, route}) {
      let arr = route.params.id.split('-')
      return Promise.all([store.dispatch('isProjectTaskDetails', arr[1]), store.dispatch('isProjectTaskType', {id: arr[0]})])
    }
  }
</script>

