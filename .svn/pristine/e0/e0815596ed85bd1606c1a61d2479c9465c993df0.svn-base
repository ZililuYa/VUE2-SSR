<template>
  <modal :title="giveForm.name.length > 0 ? '编辑任务' : '添加任务'" v-model="show" @hide="$emit('close-model')" :footer="false">
    <formData ref="form" class="form-horizontal paddingRight al-addTask">
      <div class="form-group">
        <label class="col-xs-2" align="right">名 称</label>
        <div class="col-xs-10">
          <input type="text" v-model="form.name" class="form-control" placeholder="请输入任务名称" validate="required" fh="addtask_name">
        </div>
        <span class="falseHints" id="addtask_name"></span>
      </div>
      <div class="form-group">
        <label class="col-xs-2" align="right">属 性</label>
        <div class="col-xs-9">
          <input type="text" v-model="form.attr" class="form-control" placeholder="请输入属性名称">
        </div>
        <div class="col-xs-1 al-addbox">
          <btn type="primary" @click="addOne">+</btn>
        </div>
      </div>
      <div class="form-group" v-for="(item, index) in form.attributes">
        <label class="col-xs-2" align="right"></label>
        <div class="col-xs-9">
          <input type="text" v-model="item.name" class="form-control" disabled>
        </div>
        <div class="col-xs-1 al-addbox">
          <btn type="primary" @click="delOne(index)"> - </btn>
        </div>
      </div>
      <div class="form-group">
        <label class="col-xs-2"></label>
        <div class="col-xs-10">
          <btn type="primary" @click="validate">提 交</btn>
        </div>
      </div>
    </formData>
  </modal>
</template>
<script>
  import api from 'src/api'
  import formData from 'components/form/form.vue'
  export default {
    name: 'addTask',
    props: {
      giveForm: {
        type: Object
      }
    },
    data () {
      return {
        show: true,
        form: {
          name: '',
          attr: '',
          attributes: []
        }
      }
    },
    components: {formData},
    created() {
      let vm = this
      if (vm.giveForm.name.length) Object.assign(vm.form, vm.giveForm)
    },
    methods: {
      addOne () {
        let vm = this
        let name = vm.form.attr
        if (!name.length) {
          vm.notify('danger', '请填写属性名称')
          return
        }
        let num = 0
        vm.form.attributes.forEach(function (item) {
          if (item.name === name) num++
        })
        if (num) {
          vm.notify('danger', '此属性名称已存在')
          return
        }
        let some = {name}
        vm.form.attributes.unshift(some)
      },
      delOne (index) {
        this.form.attributes.splice(index, 1)
      },
      validate () {
        /**
         * 表单验证
         */
        let vm = this
        let fo = this.$refs.form.validate()
        if (!fo) return false
        if (!vm.form.attributes.length) {
          vm.notify('danger', '请添加至少一个属性名称')
          return
        }
        vm.doSubmit()
      },
      doSubmit () {
        /**
         * 提交添加
         */
        let vm = this
        let url = '/taskType/insert'
        let params = JSON.stringify(vm.form)
        if (vm.giveForm.name.length) {
          url = '/taskType/update'
          let some = {id: vm.giveForm.id}
          Object.assign(some, vm.form)
          params = JSON.stringify(some)
        }
        api.post(url, params).then((response) => {
          if (response.code !== 200) {
            vm.notify('danger', response.message)
            return
          }
          vm.$emit('close-model', 1)
        }).catch((error) => {
          console.log(error)
        })
      },
      notify(type, content) {
        /**
         * 封装一个弹出消息
         * param {String} type 类型
         * param {String} content 内容
         */
        this.$notify({ type, content, dismissible: false, duration: 1000 })
      }
    }
  }
</script>
<style lang="less">
.paddingRight {
  padding-right: 50px !important
}
.al-addTask {
  label {
    line-height: 34px
  }
  .form-group {
    .al-addbox {
      padding: 0
    }
  }
  .col-xs-9 {
    padding-left: 0
  }
  .col-xs-10 {
    padding-left: 0
  }
}
</style>
