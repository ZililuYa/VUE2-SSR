<template>
  <div>
    <div class="featurebar">
      <ul class="ul">
        <li id="undoneTab" class="active">
          <a>所有权限</a>
        </li>
      </ul>
    </div>
    <div class="main">
      <table class="table table-bordered">
        <thead>
          <tr>
            <th>模块</th>
            <th>方法</th>
          </tr>
        </thead>
        <tbody>
          <tr v-if="powerList.jurisdictionList" v-for="(item, key) in powerList.jurisdictionList">
            <td>
              {{item.name}}
            </td>
            <td>
              <span v-if="item.child" v-for="(child, index) in item.child">
                <input type="checkbox" :id="child.id" :value="child.id" :checked="child.check==='true'?true:false" @change="getChecked(key, index)"> {{child.name}}
              </span>
            </td>
          </tr>
          <tr v-else>
            <td colspan="2">
              暂无数据
            </td>
          </tr>
          <tr>
            <td><input type="checkbox" v-model="allChecked" @change="getAllChecked()"> 全选</td>
            <td>
              <div class="view-btn-group">
                <btn class="" type="primary" @click="doSubmit">保存</btn>
                <a href="javascript:void(0)" class="btn btn-default" @click="goBack">返回</a>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</template>

<script>
  import { mapGetters } from 'vuex'
  import api from 'src/api'
  export default {
    name: 'editPower',
    title () {
      return '权限编辑'
    },
    data () {
      return {
        index: false,
        datas: [],
        powerId: '',
        checkedList: [],
        allChecked: false
      }
    },
    computed: {
      ...mapGetters({
        powerList: 'powerList'   // 所有权限
      })
    },
    mounted () {
      console.log('客户端接收到的~~~所有权限~~~数据：', this.powerList)
      this.powerId = this.$route.params.id
      this.datas = this.powerList.jurisdictionList
    },
    asyncData ({store, route}) {
      let param = {
        id: route.params.id,
        type: 2
      }
      return store.dispatch('isPowerList', param)
    },
    methods: {
      getChecked (key, index) {
        /**
         * checkbox change事件
         **/
        let vm = this
        vm.datas[key].child[index].check = vm.datas[key].child[index].check === 'true' ? 'false' : 'true'
        console.log(vm.datas[key].child[index].check)
        vm.datas.forEach(function (item) {
          if (item.check === 'false') {
            vm.allChecked = false
          }
        })
      },
      getAllChecked () {
        /**
         * 全选
         **/
        let vm = this
        vm.datas.forEach(function (item) {
          if (vm.allChecked) {
            item.check = 'true'
          } else {
            item.check = 'false'
          }
        })
      },
      doSubmit () {
        /**
         * 提交
         **/
        let vm = this
        let params = {}
        params.id = vm.powerId
        vm.datas.forEach(function (item) {
          if (item.child) {
            item.child.forEach(function (i) {
              if (i.check === 'true') {
                vm.checkedList.push(i.id)
              }
            })
          }
        })
        params.jurisdictionId = vm.checkedList.join(',')
        api.post('/permissiongroup/update', params).then((response) => {
          if (response.code === 200) {
            this.$notify({
              type: 'success',
              content: '修改成功'
            })
            vm.goBack()
          } else {
            this.$notify({
              type: 'danger',
              content: response.message
            })
          }
        }).catch((error) => {
          console.log(error)
        })
      },
      goBack () {
        /**
         * 返回上一页
         **/
        this.$router.go(-1)
      }
    }
  }
</script>

<style lang="less">
  .main {
    padding: 20px;
  }

  #add_modal {
    .control-label {
      text-align: left;
    }
  }
</style>
